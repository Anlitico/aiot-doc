# 麦克风选型与乐鑫 AFE 算法集成指南

本文档详细介绍了如何利用乐鑫 AFE (Audio Front-End) 方案提升语音玩具的听觉能力，并对不同数量麦克风方案进行了深度对比。

## 1. 方案对比：1-Mic vs. 2-Mic vs. 3-Mic (Korvo 模式)

针对“海绵宝宝”智能互动场景，我们选择 **2-Mic (双麦方案)**。以下是详细的技术权衡：

| 维度 | 1-Mic (单麦) | 2-Mic (双麦) [最优选] | 3-Mic (多麦阵列) |
| :--- | :--- | :--- | :--- |
| **空间感** | 无，全向拾音 | 有，具备方向性 | 强，360 度平面拾音 |
| **抗噪能力** | 弱，只能过滤背景白噪音 | 强，可过滤非目标方向的人声 | 极强，可锁定特定空间点 |
| **回声消除 (AEC)** | 基础级 | **进阶级 (效果更干净)** | 专业级 (调试极难) |
| **算力开销** | 极低 | 中等 (ESP32-S3完美适配) | 极高 (容易挤占 WebRTC 资源) |
| **结构难度** | 简单，单孔密封 | 中等，需保证两孔间距和一致性 | 复杂，需三孔位置精准对齐 |
| **用户场景** | 近距离手持 | **手持 / 1.5米内桌面放置** | 远场 (3米以上) 智能音箱 |

### 为什么不选 3-Mic (Korvo 开发板模式)？
1. **结构不适配**：海绵宝宝形状不规则，布置等边三角形或线性阵列会严重破坏外观美感，且三孔密封的一致性很难保证。
2. **算力平衡**：量产版硬件需要留出足够的算力给 WebRTC 协议栈和实时语音加密。三路音频的前端处理会占用过多的 DMA 和内存带宽。
3. **边际效益**：在 1.5 米内的近场通话场景下，双麦提供的“波束成形”效果与三麦几乎无异，但成本和失误率显著降低。

## 2. 关键决策：收音距离定位 (Picking-up Distance)

在设计前，必须明确本产品的收音场景：

- **远场 (Far-field, >3m)**：如天猫精灵。需要 4-6 麦阵列，主打家庭环境下远距离喊话。由于海绵宝宝外壳材质（布料/硅胶）对声音的吸收和不规则折射，强做远场会导致错误唤醒严重。
- **中场 (Mid-field, 0.5m-2m)**：**本项目的核心定位**。适用于放在办公桌、床头或者拿在手里。
- **技术保证**：双麦 AFE 配合自动增益控制 (AGC)，可以在 1.5 米范围内提供极佳的信噪比，同时过滤远处无关的杂噪音。

**结论**：保持 **2-Mic 方案**，足以覆盖用户所有“亲密交互”场景。

## 3. 乐鑫 AFE 核心技术指标
针对 ESP32-S3，乐鑫 AFE 提供以下处理能力：
- **采样率支持**：固定 16kHz（AI 语音的最佳采样率）。
- **AEC (回声消除)**：支持 200ms 以上的回声尾长消除。
- **算法加速**：全面利用 S3 的 AI 指令集（Xtensa LX7 + AI extension）。

## 4. 麦克风选型建议

推荐使用 **数字 I2S 接口的 MEMS 麦克风**（如 Goertek 或瑞声系列）。

| 参数 | 推荐值 | 理由 |
| :--- | :--- | :--- |
| **信号类型** | I2S (Digital) | 免去外部 ADC 芯片，杜绝模拟信号干扰。 |
| **信噪比 (SNR)** | >= 64 dB | 保证在弱信号（轻声说话）时的音频纯度。 |
| **声过载点 (AOP)** | >= 120 dB SPL | 防止近距离大声说话或喇叭大音量时音频削波。 |
| **工作电流** | < 1 mA | 满足低功耗待机要求。 |

**具体型号推荐**：
- **1-Mic**: MSM261S4030H0 (性能稳定，供应链极其成熟)。
- **2-Mic (配对型)**：建议选用厂家 **配对出货(Matched Pair)** 的规格。灵敏度差值应 **< ±1.0 dB**，相位差应 **< 5°**，这对应 2-Mic AFE 算法的收敛速度至关重要。

## 3. 2-Mic AFE 的硬件布局要求 (重要)
如果选择双麦方案提升性能，必须遵循乐鑫的几何规范：
1.  **间距 (Distance)**：两颗麦克风中心轴距固定在 **40mm - 65mm**。
2.  **方向 (Orientation)**：双麦中心点的轴线应处于水平位置，尽量正对用户脸部。
3.  **密封性**：每一颗麦克风必须有独立的密封硅胶套，严禁两个麦克风在玩具内部共享空气腔。

## 4. 声学避坑 Checklist (量产必看)
- [ ] **物理声学隔离 (核心)**：
    - **原理**：如果麦克风在玩具内部能“听到”喇叭的声音（通过空气震动），AEC 算法将无法处理不规则的反射模式。
    - **对策**：必须确保喇叭有密封音腔，且麦克风通过硅胶套与外壳开口**紧密耦合**，杜绝玩具内部串音。
- [ ] **机械振动隔离**：喇叭工作时会由于震动通过外壳传导给麦克风（Structure-borne Sound）。建议喇叭使用软质悬挂或密封泡棉，麦克风通过软质硅胶套悬浮，不与外壳刚性连接。
- [ ] **导音孔设计**：外壳拾音孔直径建议在 1.0mm - 1.5mm 之间，长度不宜超过 5mm。孔径太小会造成频率畸变。
- [ ] **风噪控制**：隐藏在织物内的麦克风需避免被化纤毛发直接遮挡，防止摩擦产生的高频噪音。

## 5. 软件集成建议 (ESP-ADF)
在代码中初始化 AFE 时，建议参数配置：
```c
afe_config_init.afe_mode = SR_MODE_LOW_COST; // 针对 S3 优化
afe_config_init.aec_init = true;
afe_config_init.se_init = true; // 开启语音增强
afe_config_init.vad_init = true;
```
更多代码实现细节，待原型调试阶段细化。
