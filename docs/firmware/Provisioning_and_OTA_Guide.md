# 配网与在线升级指南 (Provisioning & OTA Update)

本指南详述了固件如何与手机 App 协同，完成 Wi-Fi 入网和后续的版本更新。

---

## 1. 蓝牙配网方案 (ESP-Provisioning over BLE)

我们采用乐鑫官方的统一配网协议。

### 1.1 固件工作流程
1. **触发检测**：系统启动时检查 NVS 存储。若无 ssid 记录，自动进入 `PROVISIONING` 模式。
2. **开启广播**：启动 BLE 广播，设备名格式通常为 `PROV_Spongebob_XXXX`。
3. **数据接收**：接收 App 通过 Protobuf 协议发送的加密 Wi-Fi 凭证。
4. **验证连接**：尝试连接 Wi-Fi。若成功，将配置写入 NVS 并**彻底释放蓝牙内存** (esp_bt_controller_deinit)。

### 1.2 物理交互建议
- **长按唤醒**：定义一个“重置按键”（例如海绵宝宝的左手感应），长按 5 秒清空 NVS 并重启进入配网模式。
- **状态灯效**：配网中开启“旋转蓝灯”，成功后绿灯闪烁 2 次。

---

## 2. 在线升级方案 (Native HTTPS OTA)

为了应对可能的 Bug 和功能更新，OTA 是量产后的救命手段。

### 2.1 分区表设计 (Partition Table)
固件必须采用双分区结构，确保升级失败不“变砖”：
- `factory`：(可选) 出厂原始版本。
- `ota_0`：当前运行分区。
- `ota_1`：待升级分区。

### 2.2 固件端操作流程
1. **触发更新**：通过 LiveKit 的 DataChannel 接收 App 推送的下载 URL。
2. **下载校验**：
   - 建立 HTTPS 连接（需配置根证书校验）。
   - 使用 `esp_ota_begin` 开始写入。
   - `esp_ota_write` 将数据流分片写入非活跃分区。
3. **自校验与切换**：
   - 下载完成后执行 `esp_ota_end` 进行 MD5 校验。
   - 调用 `esp_ota_set_boot_partition` 设置下一次启动分区。
   - 重启设备。

---

## 3. 给固件开发的特别提醒 (Tips)

### 3.1 内存争抢 (DRAM Management)
- **注意**：蓝牙协议栈 (BT Stack) 极其吃内存。**严禁在蓝牙配网时开启 LiveKit 或 AFE 任务**。
- **策略**：配网成功后务必执行内存清理，确保全双工对话有足够的 PSRAM 使用。

### 3.2 升级安全策略
- **电量检查**：电量低于 20% 时应拒绝 OTA 升级，防止中途断电损坏 Flash。
- **对话保护**：在用户正在对话时严禁触发 OTA 自动下载，需先给用户视觉提醒或在后台静默下载后，等待海绵宝宝进入深睡眠时自动重启。

---

## 4. 配合 App 开发的 Checklist
- [ ] 固件确定 BLE 广播的特征值和安全密钥 (PoP)。
- [ ] 后端服务器配置固件 bin 文件的 HTTPS 下载路径。
- [ ] 固件实现 `version` 查询命令，供 App 检查当前版本号。
