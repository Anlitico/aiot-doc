# AIoT 智能语音玩具项目全流程 Checklist

此文档用于汇总硬件、软件、结构及生产过程中的所有关键注意项，确保在研发和试产阶段不“踩坑”。

## 一、 硬件设计关键项 (Hardware Design)

### 1.1 天线与 Wi-Fi 稳定性 (核心)
- [ ] **物理净空**：PCB 天线正前方 15mm 内无电池、喇叭、金属件。
- [ ] **PCB 镂空**：如果使用板载天线，天线投影区域的所有层均严禁铺铜。
- [ ] **屏蔽料避让**：确保海绵宝宝外壳没有金属漆、电镀层或含金属纤维的织物。
- [ ] **RSSI 预测试**：量产前在装配成品内测试 Wi-Fi 信号强度，确保不低于 -70dBm。

### 1.2 模组与供电 (稳定性)
- [ ] **LDO 输出能力**：使用 **SGM2212** 或同级别 LDO，确保 3.3V 输出能力 >= **800mA**。
- [ ] **电源完整性**：模组 3V3 引脚旁必须放置 **22uF** 陶瓷电容，LDO 输入输出端紧贴 10uF 电容，防止 Wi-Fi 突发电流导致重启。
- [ ] **USB-C CC 逻辑**：在 CC1/CC2 引脚各接一个 **5.1kΩ 下拉电阻**，以支持 C-to-C 充电线供电。
- [ ] **USB ESD 防护**：USB D+/D- 路径需增加集成的 **ESD 保护二极管** (如 SRV05-4)。
- [ ] **PSRAM 规格复核**：选型确认是 8MB Octal SPI (OPI) 模式，且工作电压与系统 3.3V 匹配。
- [ ] **USB 直接调试**：GPIO 19/20 连接到 USB-C 接口，利用 S3 原生 USB-JTAG 进行免芯片烧录。
- [ ] **芯片散热布局**：ESP32-S3 底部 GND Pad 需通过 9-16 个过孔连接至主地层。
- [ ] **物理进入烧录模式**：GPIO 0 必须预留物理按键或易操作的短接测试点，作为程序跑飞后的保底烧录手段。
- [ ] **Strapping Pins 复核**：启动前需处于悬空或正确电平，严禁接可能导致无法启动的强拉负载。
- [ ] **电池双重保护**：确认锂电池自带保护板（PCM），防止过充、过放。
- [ ] **充电电流设定**：确认 $R_{prog}$ 电阻值（如 1.5kΩ 对应 800mA），防止充电发热过大。
- [ ] **电量监测精度**：使用 1% 精度电阻进行分压采样，并在软件中进行 ADC 校准。

## 4. 机械与外观设计 (ID/MD) —— [已定稿 (Ready for 3D Modeling)]
- [x] **空间布局定义**：完成垂直主板 + 两侧圆环副板的“分布式感官”架构。
- [x] **内部骨架 (Chassis)**：定义了 PC+ABS 材质的零件承载支架及电池托底。
- [x] **声学工程**：
  - [x] 喇叭背部出音 + 45° 反射面设计。
  - [x] 麦克风二级密封 (Sleeve + Interface) 逻辑。
  - [x] 喇叭悬浮减震 (Poron) 与泄压阀设计。
- [x] **交互细节**：
  - [x] 隐形多功能键 (Hidden MFB) 方案定稿。
  - [x] 半透明硅胶导光与光电隔离遮光。
- [x] **PCB 物理整合**：分布式母女板 + FPC 连接方案，成本调研已完成。
- [x] **量产与装配 (DFA)**：完成了单向递进式装配流程及防呆设计。

### 1.3 音频路径 (质量)
- [ ] **麦克风配对精度**：2-Mic 方案必须选用灵敏度差异 **< ±1dB** 的配对型号。
- [ ] **数字麦密封**：麦克风必须通过硅胶套与外壳开口**紧密耦合**，禁止在玩具内部漏音。
- [ ] **机械振动隔离**：麦克风通过软质硅胶套悬浮安装，禁止与外壳刚性连接；喇叭模组需加装减震泡棉。
- [ ] **I2S 走线**：I2S 信号线（BCLK, WS, DATA）长度尽可能等长，且远离电感等干扰源。
- [ ] **功放散热**：MAX98357A 下方需进行铺铜过孔散热设计。
- [ ] **喇叭极性验证**：量产组装时确保喇叭正负极连接一致，防止多台设备间声场相位抵消。
- [ ] **物理声学隔离**：确保喇叭模组（音腔）与麦克风之间没有直接的空气传播路径，防止由于内部串音导致 AEC 失效。

---

## 二、 原型开发与软件 (Firmware/AI)

### 2.1 LiveKit 对接
- [ ] **Opus 编码加速**：确认开启了 ESP32-S3 的 AI 指令集硬件加速。
- [ ] **内存溢出监控**：实时监测 PSRAM 剩余空间，防止 WebRTC 握手时内存耗尽。
- [ ] **预连接/长连接预热策略**：
    - **系统初始化**：开机联网后立即后台获取 Token 并建立 LiveKit 长连接。
    - **待机逻辑**：保持信令连接不掉线，但不开启麦克风推流，以节省带宽。
    - **快速唤醒**：确保在唤醒词触发 100ms 内瞬间激活音频 Track 推流，消除首句“愣神”。
    - **自动休眠**：连续 300 秒无语音交互后，主动断开长连接并进入低功耗模式。
- [x] **唤醒词方案 (Wake Word)**：已锁定 Picovoice (快速落地) + 外置硬件芯片 (长续航备选) 双路径。
- [ ] **断线重连机制**：实现 Wi-Fi 掉线和 WebSocket 异常后的自动指数级退避重连。

### 2.2 音频算法与打断逻辑 (AFE & Interruption)
- [ ] **AEC 软件环回**：确认采用乐鑫官方推荐的**内部软件环回方案**，硬件上无需物理反馈线。
- [ ] **AFE 处理顺序**：确认算法链路为：AEC -> BSS/NS -> VAD (本地模式) -> WakeNet，严禁顺序颠倒。
- [ ] **本地抢占实现**：当本地 VAD 判定插话时，固件必须在 50ms 内执行 `i2s_zero_dma_buffer` 强行清场。
- [ ] **软消音处理**：打断瞬间执行 8-10ms 的 Fade-out 线性衰减，防止喇叭爆音。

### 2.3 系统稳定性与资源管理 (Performance)
- [ ] **内存分配锁死**：超过 4KB 的音频 buffer 必须显式申请在 PSRAM，严禁占用 SRAM。
- [ ] **I2S DMA 禁区**：I2S 硬件 DMA 描述符及其缓存必须强制留在内部 SRAM，防止 Wi-Fi 并发导致音频断续。
- [ ] **双核分工隔离**：Core 1 锁定跑音频采集与编解码，Core 0 跑网络请求与系统管理，防止任务抖动导致丢包。
- [ ] **自动降温策略**：开启官方电源管理 DFS，Idle 状态自动降频至 80MHz，防止公仔内部过热。
- [ ] **双重看门狗**：开启 Task WDT (业务死锁检测) 和 System WDT (内核锁死重启)。

### 2.4 配网、OTA 与诊断 (Maintenance)
- [ ] **资源分时隔离**：开启蓝牙配网时，必须强制关闭 AFE 和 LiveKit 任务，防止内存溢出导致配网失败。
- [ ] **OTA 安全围栏**：电量 <20% 或正在交互时禁用 OTA 下载；升级成功后需验证版本号才切换启动分区。
- [ ] **存储磨损均衡**：禁止频繁（秒级）写入 NVS，所有配置变更需在内存缓冲并定时/关机前 commit。
- [ ] **远程“黑匣子”**：接入 ESP-Insights，确保 500 台外测中发生的任何重启/崩溃都有 Core Dump 回传。

### 2.5 Flash 与分区表 (Storage)
- [ ] **16MB 全量识别**：sdkconfig 必须显式选定 16MB Flash，防止误设为 4MB 导致无法启动。
- [ ] **独立模型分区**：WakeNet 模型由于必须放在独立分区而非 app 分区，以缩短 OTA 时间。
- [ ] **VAD 灵敏度**：调整本地语音活动检测（VAD）阈值，防止玩具自说自话。
- [ ] **状态指示**：LED 灯效需覆盖：配网中、连接成功、倾听中、思考中、低电平告警。

---

## 三、 ID 结构与量产 (ID & Manufacturing)

### 3.1 100-500台试产准备
- [ ] **烧录治具**：设计简易的顶针烧录架，避免每台都插 USB 线。
- [ ] **音腔设计**：喇叭必须有独立且密闭的后室，避免低音发散及干扰麦克风。
- [ ] **组装防呆**：内部线束插件需做防呆设计，防止极性反接。
- [ ] **固件预烧录**：确定出厂时的预设 Wi-Fi 配网模式（如 Ble-Config）。

---

## 四、 待定事项说明 (Todo List)
- [ ] “海绵宝宝”外壳具体厚度及材质实验报告（影响天线与散热）。
- [ ] 确定是否需要增加物理音量调节按键（暂定通过手机 App 调节）。
- [ ] 完成基于 Korvo-1 的第一个全双工对讲 Demo 闭环测试。

## 五、 出口合规与认证 (Certification - FCC/UN38.3) —— [New!]
- [ ] **FCC ID 复用策略**：确认购买的模组屏蔽罩印有 `FCC ID: 2AC7Z-ESPS3WROOM1`。
- [ ] **合规设计自查**：
  - [ ] 硬件：天线已留出 5mm 净空，USB 线已预留共模电感焊盘。
  - [ ] 固件：国家码已锁定为 `US` (禁止 CH12/13)，发射功率限制在 19.5dBm。
- [ ] **定频固件**：准备好支持 AT 指令的 RF 测试固件 (.bin)。
- [ ] **标签规范**：机身或说明书上需印刷 `Contains FCC ID: ...`。
- [ ] **电池认证**：向电池供应商索取具体的 UN38.3 测试报告原件。
